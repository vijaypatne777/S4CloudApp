sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessagePopover","sap/m/MessageItem","sap/m/Button","sap/m/MessageBox"],function(e,t,r,a,s,i,o,n,c,d){"use strict";var l;return e.extend("CreditDebit.UploadCreditDebitMemo.controller.Worklist",{formatter:r,onInit:function(){var e=this.byId("cRB");var t=this.byId("dRB");var r=this.byId("rgM");var a=r.getSelectedIndex();this._cIndex=a;if(this._cIndex===0){var s=this.byId("myContainer");var i=sap.ui.xmlfragment(this.createId("cmF"),"CreditDebit.UploadCreditDebitMemo.view.CreditMemo",this);this._cmF=i;s.addContent(i)}this._tModel=new sap.ui.model.json.JSONModel;this._dModel=this.getOwnerComponent().getModel("dMemo");this._cModel=this.getOwnerComponent().getModel();this._oPromises=[];this._msgArr=[];this._msgData={msgs:this._msgArr};var o=this.byId("cUpload");o.setEnabled(false)},onUpdateFinished:function(e){},onPress:function(e){},onShareInJamPress:function(){},onSearch:function(e){},onRefresh:function(){},_showObject:function(e){},_applySearch:function(e){},handleUploadPress:function(){var e=this;var t;var r=[];var a={trec:r};var s=this.byId("fileUploader");if(this._cIndex===0){t=this.byId(sap.ui.core.Fragment.createId("cmF","memoTable"))}if(this._cIndex===1){t=this.byId(sap.ui.core.Fragment.createId("dmF","memoTable"))}if(!s.getValue()){i.show("Select the file first!");return}else{var o=s.getFocusDomRef();var n=o.files[0];if(n&&window.FileReader){var c=new FileReader;c.onload=function(s){var i=s.target.result;var o=i.replace(/\n/g,",").split(",");var n;if(e._cIndex===1){n=20}else{n=16}var c=o.splice(0,n);while(o.length-1>0){var d={};var l={};var u=o.splice(0,n);for(var m=0;m<u.length;m++){d[c[m]]=u[m].trim();if(e._cIndex===1){switch(m){case 0:l["NOrder"]=d[c[m]];break;case 1:l["DType"]=d[c[m]];break;case 2:l["Sorg"]=d[c[m]];break;case 3:l["Dchnl"]=d[c[m]];break;case 4:l["Div"]=d[c[m]];break;case 5:l["SParty"]=d[c[m]];break;case 6:l["Cref"]=d[c[m]];break;case 7:l["Oreason"]=d[c[m]];break;case 8:l["Pterm"]=d[c[m]];break;case 9:l["Currency"]=d[c[m]];break;case 10:l["Pmethod"]=d[c[m]];break;case 11:l["HTID"]=d[c[m]];break;case 12:l["Htext"]=d[c[m]];break;case 13:l["Mat"]=d[c[m]];break;case 14:l["Quan"]=d[c[m]];break;case 15:l["CType"]=d[c[m]];break;case 16:l["Cvalue"]=d[c[m]];break;case 17:l["ITID"]=d[c[m]];break;case 18:l["Itext"]=d[c[m]];break;case 19:l["Bblock"]=d[c[m]];break}}else{switch(m){case 0:l["NOrder"]=d[c[m]];break;case 1:l["DType"]=d[c[m]];break;case 2:l["Sorg"]=d[c[m]];break;case 3:l["Dchnl"]=d[c[m]];break;case 4:l["Div"]=d[c[m]];break;case 5:l["SParty"]=d[c[m]];break;case 6:l["Cref"]=d[c[m]];break;case 7:l["Oreason"]=d[c[m]];break;case 8:l["Pterm"]=d[c[m]];break;case 9:l["Currency"]=d[c[m]];break;case 10:l["Pmethod"]=d[c[m]];break;case 11:l["Mat"]=d[c[m]];break;case 12:l["Quan"]=d[c[m]];break;case 13:l["CType"]=d[c[m]];break;case 14:l["Cvalue"]=d[c[m]];break;case 15:l["Bblock"]=d[c[m]];break}}}r.push(l)}e._tModel.setData(a);t.setModel(e._tModel);var h=e.validateFileData();if(h){var p=e.byId("cUpload");p.setEnabled(true);e.byId("fileUploader").setEnabled(false);e.byId("tUpload").setEnabled(false);e.byId("rgM").setEnabled(false)}};c.readAsBinaryString(n)}}},validateFileData:function(){var e=this._tModel.getData();for(var t=0;t<e.trec.length;t++){if(e.trec[t].NOrder==="X"){if(this._cIndex===0&&e.trec[t].DType!=="CR"){d.error("Template for CreditMemo request is wrong ,Please select proper template");return false}if(this._cIndex===1&&e.trec[t].DType!=="DR"){d.error("Template for DebitMemo request is wrong ,Please select proper template");return false}}}return true},handleRefresh:function(){this._tModel.setData();this.byId("cUpload").setEnabled(false);this.byId("tUpload").setEnabled(true);this.byId("fileUploader").setEnabled(true);this.byId("rgM").setEnabled(true);this.byId("fileUploader").clear();var e=sap.ui.getCore().byId("logBut");e.destroy()},handlePost:function(){var e=this;var t=0;sap.ui.core.BusyIndicator.show();Promise.allSettled=function(r){r.forEach(function(r){r.then(function(a){t=t+1;if(t===e._oPromises.length){if(e._cIndex===0){sap.ui.core.BusyIndicator.hide()}e.promiseCompleted()}return r},function(r){t=t+1;if(t===e._oPromises.length){if(e._cIndex===0){sap.ui.core.BusyIndicator.hide()}e.promiseCompleted()}})});return r};var r=[];if(this._cIndex===1){r=this.createDebitMemos()}if(this._cIndex===0){r=this.createCreditMemos()}var a=Promise.allSettled(r)},createDebitMemos:function(){var e=this._tModel.getData();var t={};var r={};var a=[];var s=0;var i=[];var o;var n=[];var c;var d="GRPID";for(var l=0;l<e.trec.length;l++){var u={};var m={};var h=[];var p={};var v=[];if(l!==0&&e.trec[l].NOrder==="X"){t.to_Item=i;d=d+s;c=this.createDebitMemo(t,d);s=s+1;n.push(c);var t={};var r={};var a=[];var u={};var i=[];t.DebitMemoRequestType=e.trec[l].DType;t.SalesOrganization=e.trec[l].Sorg;t.DistributionChannel=e.trec[l].Dchnl;t.OrganizationDivision=e.trec[l].Div;t.SoldToParty=e.trec[l].SParty;t.SDDocumentReason=e.trec[l].Oreason;t.CustomerPaymentTerms=e.trec[l].Pterm;t.PaymentMethod=e.trec[l].Pmethod;t.TransactionCurrency=e.trec[l].Currency;t.PurchaseOrderByCustomer=e.trec[l].Cref;t.HeaderBillingBlockReason="";r.LongTextID=e.trec[l].HTID;r.Language="E";r.LongText=e.trec[l].Htext;a.push(r);t.to_Text=a;u.Material=e.trec[l].Mat;u.RequestedQuantity=e.trec[l].Quan;p.Language="E";p.LongTextID=e.trec[l].ITID;p.LongText=e.trec[l].Itext;m.ConditionType=e.trec[l].CType;m.ConditionRateValue=e.trec[l].Cvalue;h.push(m);v.push(p);u.to_Text=v;u.to_PricingElement=h;i.push(u)}else{if(l==0){t.DebitMemoRequestType=e.trec[l].DType;t.SalesOrganization=e.trec[l].Sorg;t.DistributionChannel=e.trec[l].Dchnl;t.OrganizationDivision=e.trec[l].Div;t.SoldToParty=e.trec[l].SParty;t.SDDocumentReason=e.trec[l].Oreason;t.CustomerPaymentTerms=e.trec[l].Pterm;t.PaymentMethod=e.trec[l].Pmethod;t.TransactionCurrency=e.trec[l].Currency;t.HeaderBillingBlockReason="";t.PurchaseOrderByCustomer=e.trec[l].Cref;r.LongTextID=e.trec[l].HTID;r.Language="E";r.LongText=e.trec[l].Htext;a.push(r);t.to_Text=a}u.Material=e.trec[l].Mat;u.RequestedQuantity=e.trec[l].Quan;p.Language="E";p.LongTextID=e.trec[l].ITID;p.LongText=e.trec[l].Itext;m.ConditionType=e.trec[l].CType;m.ConditionRateValue=e.trec[l].Cvalue;h.push(m);v.push(p);u.to_Text=v;u.to_PricingElement=h;i.push(u)}}t.to_Item=i;s=s+1;d=d+s;c=this.createDebitMemo(t,d);n.push(c);return n},createDebitMemo:function(e,t){var r=this._dModel;var a=this;var s=new Promise(function(s,i){r.create("/A_DebitMemoRequest",e,{success:function(e){var t={};t["Mtype"]="Success";t["Msg"]="Debit memo request is created with"+" "+e.DebitMemoRequest;t["DebitMemoNo"]=e.DebitMemoRequest;t["eTag"]=e.__metadata.etag;a._msgArr.push(t);s()},error:function(e){var t={};t["Mtype"]="Error";t["Msg"]=e.responseText;a._msgArr.push(t);i()},groupId:t})});this._oPromises.push(s);return s},promiseCompleted:function(){var e=this;var t=0;Promise.allSettled=function(r){r.forEach(function(r){r.then(function(a){t=t+1;if(t===e._bPromises.length){sap.ui.core.BusyIndicator.hide();e.removeBlockCompleted()}return r},function(r){t=t+1;if(t===e._bPromises.length){sap.ui.core.BusyIndicator.hide();e.removeBlockCompleted()}})});return r};if(this._cIndex===1){var r=this.removeDMBillingBlock();var a=Promise.allSettled(r)}else{this.displayLog()}},handleMessagePopoverPress:function(e){l.toggle(e.getSource())},memoSelected:function(){var e=this.byId("rgM");var t=e.getSelectedIndex();if(t===1){this._cmF.destroy();var r=this.byId("myContainer");var a=sap.ui.xmlfragment(this.createId("dmF"),"CreditDebit.UploadCreditDebitMemo.view.DebitMemo",this);this._dmF=a;r.addContent(a);this._cIndex=t}else{this._dmF.destroy();var r=this.byId("myContainer");var a=sap.ui.xmlfragment(this.createId("cmF"),"CreditDebit.UploadCreditDebitMemo.view.CreditMemo",this);this._cmF=a;r.addContent(a);this._cIndex=t}},createCreditMemos:function(){var e=this._tModel.getData();var t={};var r=[];var a;var s=[];var i;var o="GRPID";var n=0;for(var c=0;c<e.trec.length;c++){var d={};var l={};var u=[];if(c!==0&&e.trec[c].NOrder==="X"){t.to_Item=r;o=o+n;i=this.createCreditMemo(t,o);n=n+1;s.push(i);var t={};var d={};var r=[];t.CreditMemoRequestType=e.trec[c].DType;t.SalesOrganization=e.trec[c].Sorg;t.DistributionChannel=e.trec[c].Dchnl;t.OrganizationDivision=e.trec[c].Div;t.SoldToParty=e.trec[c].SParty;t.SDDocumentReason=e.trec[c].Oreason;t.CustomerPaymentTerms=e.trec[c].Pterm;t.PaymentMethod=e.trec[c].Pmethod;t.TransactionCurrency=e.trec[c].Currency;t.PurchaseOrderByCustomer=e.trec[c].Cref;d.Material=e.trec[c].Mat;d.RequestedQuantity=e.trec[c].Quan;l.ConditionType=e.trec[c].CType;l.ConditionRateValue=e.trec[c].Cvalue;u.push(l);d.to_PricingElement=u;r.push(d)}else{if(c==0){t.CreditMemoRequestType=e.trec[c].DType;t.SalesOrganization=e.trec[c].Sorg;t.DistributionChannel=e.trec[c].Dchnl;t.OrganizationDivision=e.trec[c].Div;t.SoldToParty=e.trec[c].SParty;t.SDDocumentReason=e.trec[c].Oreason;t.CustomerPaymentTerms=e.trec[c].Pterm;t.PaymentMethod=e.trec[c].Pmethod;t.TransactionCurrency=e.trec[c].Currency;t.PurchaseOrderByCustomer=e.trec[c].Cref}d.Material=e.trec[c].Mat;d.RequestedQuantity=e.trec[c].Quan;l.ConditionType=e.trec[c].CType;l.ConditionRateValue=e.trec[c].Cvalue;u.push(l);d.to_PricingElement=u;r.push(d)}}t.to_Item=r;n=n+1;o=o+n;i=this.createCreditMemo(t,o);s.push(i);return s},createCreditMemo:function(e,t){var r=this._cModel;var a=this;var s=new Promise(function(s,i){r.create("/A_CreditMemoRequest",e,{success:function(e){var t={};t["Mtype"]="Success";t["Msg"]="Credit memo request is created with"+" "+e.CreditMemoRequest;a._msgArr.push(t);s()},error:function(e){var t={};t["Mtype"]="Error";t["Msg"]=e.responseText;a._msgArr.push(t);i()},groupId:t})});this._oPromises.push(s);return s},removeDMBillingBlock:function(){var e=this._dModel;var t="GID";var r=[];for(var a=0;a<this._msgArr.length;a++){var s=this;t=t+a;var i={};var o=this._msgArr[a].eTag;var n=this._msgArr[a].DebitMemoNo;i.HeaderBillingBlockReason=" ";var c=new Promise(function(r,a){var s=e.createKey("/A_DebitMemoRequest",{DebitMemoRequest:n});e.update(s,i,{success:function(e){var t={};r()},error:function(e){var t={};a()},eTag:o,groupId:t})});r.push(c)}this._bPromises=r;return r},removeBlockCompleted:function(){this.displayLog()},displayLog:function(){var e=new n({type:"{type}",title:"{title}",activeTitle:"{active}",description:"{description}",subtitle:"{subtitle}",counter:"{counter}"});l=new o({items:{path:"/",template:e},activeTitlePress:function(){}});var t=0;var r=0;var a=[];for(var s=0;s<this._msgArr.length;s++){var i={};if(this._msgArr[s].Mtype=="Success"){i["type"]=this._msgArr[s].Mtype;i["title"]="Success Message";i["active"]=false;i["description"]=this._msgArr[s].Msg;if(this._cIndex===1){i["subtitle"]="Debit memo request created successfully"}else{i["subtitle"]="Credit memo request created successfully"}t=t+1;i["conunter"]=t}else{i["type"]=this._msgArr[s].Mtype;i["title"]="Error Message";i["active"]=true;i["description"]=this._msgArr[s].Msg;if(this._cIndex===1){i["subtitle"]="Debit memo request creattion Failed"}else{i["subtitle"]="Credit memo request creattion Failed"}r=r+1;i["conunter"]=t}a.push(i)}var d=new sap.ui.model.json.JSONModel;d.setData(a);this.getView().setModel(d);var u=new c({id:"logBut",text:"Log",type:"Emphasized",width:"6rem"});u.addDependent(l);u.attachPress(this.handleMessagePopoverPress);var m=this.getView().byId("oToolBar");m.addContent(u);this.byId("cUpload").setEnabled(false);this.byId("tUpload").setEnabled(false);this.byId("fileUploader").setEnabled(false)}})});